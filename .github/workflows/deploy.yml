name: Build and Deploy VSTO Add-in

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      run: nuget restore decksterity.sln
      
    - name: Build solution
      run: msbuild decksterity.sln /p:Configuration=Release /p:Platform="Any CPU" /p:PublishUrl="https://avirut.github.io/decksterity/"
      
    - name: Publish ClickOnce application
      run: msbuild decksterity.csproj /t:Publish /p:Configuration=Release /p:Platform="Any CPU" /p:PublishUrl="https://avirut.github.io/decksterity/" /p:InstallUrl="https://avirut.github.io/decksterity/"
      
    - name: Prepare deployment files
      shell: powershell
      run: |
        # Create deployment directory
        New-Item -ItemType Directory -Force -Path "deployment"
        
        # Copy published files
        Copy-Item -Path "bin\Release\app.publish\*" -Destination "deployment\" -Recurse -Force
        
        # Create index.html for user-friendly access
        @"
        <!DOCTYPE html>
        <html>
        <head>
            <title>Decksterity PowerPoint Add-in</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .install-button { background: #0078d4; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 20px 0; }
                .install-button:hover { background: #106ebe; }
            </style>
        </head>
        <body>
            <h1>Decksterity PowerPoint Add-in</h1>
            <p>Enhance your PowerPoint presentations with visual elements and layout tools.</p>
            
            <h2>Installation</h2>
            <p>Click the button below to install or update the Decksterity add-in:</p>
            <a href="setup.exe" class="install-button">Install Decksterity</a>
            
            <h2>Features</h2>
            <ul>
                <li>Harvey Balls (progress indicators)</li>
                <li>Directional arrows</li>
                <li>Icons (check, cross, plus, minus, question, ellipsis)</li>
                <li>Stoplight indicators</li>
                <li>Advanced alignment and distribution tools</li>
            </ul>
            
            <h2>Requirements</h2>
            <ul>
                <li>Microsoft PowerPoint 2016 or later</li>
                <li>.NET Framework 4.7.2</li>
                <li>Visual Studio Tools for Office Runtime</li>
            </ul>
            
            <p><small>The add-in will automatically check for updates and install them when available.</small></p>
        </body>
        </html>
        "@ | Out-File -FilePath "deployment\index.html" -Encoding UTF8
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deployment
        force_orphan: true
